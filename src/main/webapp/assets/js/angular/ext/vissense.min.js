"use strict";function async(a,b){return function(){var c=arguments;return defer(function(){a.apply(void 0,c)},b||0)}}function debounce(a,b){var c=noop;return function(){var d=this,e=arguments;c(),c=defer(function(){a.apply(d,e)},b)}}function defaults(a,b){var c=isObject(b),d=isObject(a);return c||d?c&&d?(forEach(Object.keys(b),function(c){void 0===a[c]&&(a[c]=b[c])}),a):c?b:a:b}function defer(a,b){var c=setTimeout(function(){a()},b||0);return function(){clearTimeout(c)}}function fireIf(a,b){return function(){return(isFunction(a)?a():a)?b():void 0}}function extend(a,b,c){for(var h,d=-1,e=Object.keys(b),f=e.length,g=isFunction(c);++d<f;)h=e[d],a[h]=g?c(a[h],b[h],h,a,b):b[h];return a}function forEach(a,b,c){var d,e,f;for(d=0,e=a.length;e>d;d++)if(f=b.call(c,a[d],d,a),void 0!==f)return f}function identity(a){return a}function isDefined(a){return void 0!==a}function isArray(a){return a&&"object"==typeof a&&"number"==typeof a.length&&"[object Array]"===Object.prototype.toString.call(a)||!1}function isElement(a){return a&&1===a.nodeType||!1}function isFunction(a){return"function"==typeof a||!1}function isObject(a){var b=typeof a;return"function"===b||a&&"object"===b||!1}function noop(){}function now(){return(new Date).getTime()}function once(a){var c,b=!1;return function(){return b||(c=a.apply(void 0,arguments),b=!0),c}}function throttle(a,b,c){var d=noop,e=!1;return function(){var f=now(),g=arguments,h=function(){e=f,a.apply(c,g)};e&&e+b>f?(d(),d=defer(h,b)):(e=f,defer(h,0))}}function viewport(a){var b=a||window;return{height:b.innerHeight,width:b.innerWidth}}function computedStyle(a,b){return(b||window).getComputedStyle(a,null)}function styleProperty(a,b){return a.getPropertyValue(b)}function isDisplayed(a,b){var c,d;return b||(b=computedStyle(a)),c=styleProperty(b,"display"),"none"===c?!1:(d=a.parentNode,isElement(d)?isDisplayed(d):!0)}function isVisibleByStyling(a,b){var c,d;return a===(b||window).document?!0:a&&a.parentNode?(c=computedStyle(a,b),d=styleProperty(c,"visibility"),"hidden"===d||"collapse"===d?!1:isDisplayed(a,c)):!1}function isInViewport(a,b){return!a||a.width<=0||a.height<=0?!1:a.bottom>0&&a.right>0&&a.top<b.height&&a.left<b.width}function percentage(a,b){var e,f,c=a.getBoundingClientRect(),d=viewport(b);return isInViewport(c,d)&&isVisibleByStyling(a)?(e=0,f=0,c.top>=0?e=Math.min(c.height,d.height-c.top):c.bottom>0&&(e=Math.min(d.height,c.bottom)),c.left>=0?f=Math.min(c.width,d.width-c.left):c.right>0&&(f=Math.min(d.width,c.right)),Math.round(1e3*(e*f/(c.height*c.width)))/1e3):0}function isPageVisible(a){return!createVisibilityApi(a||window).isHidden()}function VisSense(a,b){if(!(this instanceof VisSense))return new VisSense(a,b);if(!isElement(a))throw new Error("not an element node");this._element=a,this._config=defaults(b,{fullyvisible:1,hidden:0,referenceWindow:window,percentageHook:percentage,visibilityHooks:[]});var c=createVisibilityApi(this._config.referenceWindow);this._config.visibilityHooks.push(function(){return!c.isHidden()})}function nextState(a,b){var c=a.state(),d=c.percentage;return b&&d===b.percentage&&b.percentage===b.previous.percentage?b:c.hidden?VisSense.VisState.hidden(d,b):c.fullyvisible?VisSense.VisState.fullyvisible(d,b):VisSense.VisState.visible(d,b)}function VisMon(a,b){var d,c=defaults(b,{strategy:[new VisMon.Strategy.PollingStrategy,new VisMon.Strategy.EventStrategy],async:!1});this._visobj=a,this._state={},this._started=!1,d="*#"+now(),this._pubsub=new PubSub({async:c.async,anyTopicName:d}),this._events=[d,"start","stop","update","hidden","visible","fullyvisible","percentagechange","visibilitychange"],this._strategy=new VisMon.Strategy.CompositeStrategy(c.strategy),this._strategy.init(this),this._pubsub.on("update",function(a){var b=a._state.percentage,c=a._state.previous.percentage;b!==c&&a._pubsub.publish("percentagechange",[a,b,c])}),this._pubsub.on("update",function(a){a._state.code!==a._state.previous.code&&a._pubsub.publish("visibilitychange",[a])}),this._pubsub.on("visibilitychange",function(a){a._state.visible&&!a._state.previous.visible&&a._pubsub.publish("visible",[a])}),this._pubsub.on("visibilitychange",function(a){a._state.fullyvisible&&a._pubsub.publish("fullyvisible",[a])}),this._pubsub.on("visibilitychange",function(a){a._state.hidden&&a._pubsub.publish("hidden",[a])}),forEach(this._events,function(a){isFunction(c[a])&&this.on(a,c[a])},this)}var STATES,createVisibilityApi=function(a){return function(a,b){var c=function(a,b){return{property:a,event:b}},d="visibilitychange",e=[c("webkitHidden","webkit"+d),c("msHidden","ms"+d),c("mozHidden","moz"+d),c("hidden",d)],f=forEach(e,function(c){return a[c.property]!==b?{isHidden:function(){return!!a[c.property]||!1},onVisibilityChange:function(b){return a.addEventListener(c.event,b,!1),function(){a.removeEventListener(c.event,b,!1)}}}:void 0});return f||{isHidden:function(){return!1},onVisibilityChange:function(){return noop}}}((a||window).document)},PubSub=function(a){function c(a){this._cache={},this._onAnyCache=[],this._config=defaults(a,{async:!1,anyTopicName:"*"})}var b=function(a,b){forEach(a,function(a){a(b)})};return c.prototype.on=function(b,c){var d,e,f;return isFunction(c)?(d=function(b){return c.apply(a,b||[])},e=this._config.async?async(d):d,f=function(a,b,c){return function(){var d=b.indexOf(a);return d>-1?(console.debug("Unregistering listener from topic",c),b.splice(d,1),console.debug("Topic",c,"has now",b.length,"listeners"),!0):!1}},b===this._config.anyTopicName?(this._onAnyCache.push(e),f(e,this._onAnyCache,"*")):(this._cache[b]||(console.debug("Initializing queue for topic",b),this._cache[b]=[]),this._cache[b].push(e),f(e,this._cache[b],b))):(console.warn("Discarding invalid listener on topic",b),noop)},c.prototype.publish=function(a,c){var d=(this._cache[a]||[]).concat(a===this._config.anyTopicName?[]:this._onAnyCache),e=!!this._config.async,f=e?async(b):function(a,c){return b(a,c),noop};return console.debug("publishing topic",e?"(async)":"(sync)",a,"to",d.length,"listeners"),f(d,c||[])},c}();VisSense.prototype.state=function(){var a=forEach(this._config.visibilityHooks,function(a){return a(this._element)?void 0:(console.debug("visibilityHook returned false -> element is not visible."),VisSense.VisState.hidden(0))},this);return a||function(a,b){var c=b.percentageHook(a,b.referenceWindow);return c<=b.hidden?VisSense.VisState.hidden(c):c>=b.fullyvisible?VisSense.VisState.fullyvisible(c):VisSense.VisState.visible(c)}(this._element,this._config)},VisSense.prototype.percentage=function(){return this.state().percentage},VisSense.prototype.element=function(){return this._element},VisSense.prototype.referenceWindow=function(){return this._config.referenceWindow},VisSense.prototype.isFullyVisible=function(){return this.state().fullyvisible},VisSense.prototype.isVisible=function(){return this.state().visible},VisSense.prototype.isHidden=function(){return this.state().hidden},VisSense.fn=VisSense.prototype,VisSense.of=function(a,b){return new VisSense(a,b)},STATES={HIDDEN:[0,"hidden"],VISIBLE:[1,"visible"],FULLY_VISIBLE:[2,"fullyvisible"]},VisSense.VisState=function(){function a(a,b,c){return c&&delete c.previous,{code:a[0],state:a[1],percentage:b,previous:c||{},fullyvisible:a[0]===STATES.FULLY_VISIBLE[0],visible:a[0]===STATES.VISIBLE[0]||a[0]===STATES.FULLY_VISIBLE[0],hidden:a[0]===STATES.HIDDEN[0]}}return{hidden:function(b,c){return a(STATES.HIDDEN,b,c)},visible:function(b,c){return a(STATES.VISIBLE,b,c)},fullyvisible:function(b,c){return a(STATES.FULLY_VISIBLE,b,c)}}}(),VisMon.prototype.visobj=function(){return this._visobj},VisMon.prototype.publish=function(a,b){var c=this._events.indexOf(a)>=0;if(c)throw new Error('Cannot publish internal event "'+a+'" from external scope.');return this._pubsub.publish(a,b)},VisMon.prototype.state=function(){return this._state},VisMon.prototype.start=function(a){if(this._started)return this;var b=defaults(a,{async:!1});return this._cancelAsyncStart&&this._cancelAsyncStart(),b.async?this.startAsync():(this.update(),this._pubsub.publish("start",[this]),this._strategy.start(this),this._started=!0,this)},VisMon.prototype.startAsync=function(a){var b,c;return this._cancelAsyncStart&&this._cancelAsyncStart(),b=this,c=defer(function(){b.start(extend(defaults(a,{}),{async:!1}))}),this._cancelAsyncStart=function(){c(),b._cancelAsyncStart=null},this},VisMon.prototype.stop=function(){this._cancelAsyncStart&&this._cancelAsyncStart(),this._started&&(this._strategy.stop(this),this._pubsub.publish("stop",[this])),this._started=!1},VisMon.prototype.update=function(){this._state=nextState(this._visobj,this._state),this._pubsub.publish("update",[this])},VisMon.prototype.on=function(a,b){return this._pubsub.on(a,b)},VisMon.Builder=function(){var a=function(a,b){var f,g,h,c=null,d=a.strategy===!1,e=!d&&(a.strategy||b.length>0);return e?(f=!!a.strategy,g=isArray(a.strategy),h=f?g?a.strategy:[a.strategy]:[],c=h.concat(b)):c=d?[]:a.strategy,c};return function(b){var c={},d=[],e=[],f=!1,g=null;return{set:function(a,b){return c[a]=b,this},strategy:function(a){return d.push(a),this},on:function(a,b){return e.push([a,b]),this},build:function(h){var j,i=function(){var i,h=a(c,d);return h===[]&&console.debug("No strategies given - update process must be handled by caller. "),c.strategy=h,i=b.monitor(c),forEach(e,function(a){i.on(a[0],a[1])}),f=!0,g=i};return f&&console.warn("Attempt to build an already built monitor."),j=f?g:i(),isFunction(h)?h(j):j}}}}(),VisMon.Strategy=function(){},VisMon.Strategy.prototype.init=noop,VisMon.Strategy.prototype.start=noop,VisMon.Strategy.prototype.stop=noop,VisMon.Strategy.CompositeStrategy=function(a){this._strategies=isArray(a)?a:[a]},VisMon.Strategy.CompositeStrategy.prototype=Object.create(VisMon.Strategy.prototype),VisMon.Strategy.CompositeStrategy.prototype.init=function(a){forEach(this._strategies,function(b){isFunction(b.init)&&b.init(a)})},VisMon.Strategy.CompositeStrategy.prototype.start=function(a){forEach(this._strategies,function(b){isFunction(b.start)&&b.start(a)})},VisMon.Strategy.CompositeStrategy.prototype.stop=function(a){forEach(this._strategies,function(b){isFunction(b.stop)&&b.stop(a)})},VisMon.Strategy.PollingStrategy=function(a){this._config=defaults(a,{interval:1e3}),this._started=!1},VisMon.Strategy.PollingStrategy.prototype=Object.create(VisMon.Strategy.prototype),VisMon.Strategy.PollingStrategy.prototype.start=function(a){return this._started||(this._clearInterval=function(b){var c=setInterval(function(){a.update()},b);return function(){clearInterval(c)}}(this._config.interval),this._started=!0),this._started},VisMon.Strategy.PollingStrategy.prototype.stop=function(){return this._started?(this._clearInterval(),this._started=!1,!0):!1},VisMon.Strategy.EventStrategy=function(a){this._config=defaults(a,{throttle:50}),this._config.debounce>0&&(this._config.throttle=+this._config.debounce),this._started=!1},VisMon.Strategy.EventStrategy.prototype=Object.create(VisMon.Strategy.prototype),VisMon.Strategy.EventStrategy.prototype.start=function(a){return this._started||(this._removeEventListeners=function(b){var c=a.visobj().referenceWindow(),d=createVisibilityApi(c),e=d.onVisibilityChange(b);return c.addEventListener("scroll",b,!1),c.addEventListener("resize",b,!1),c.addEventListener("touchmove",b,!1),function(){c.removeEventListener("touchmove",b,!1),c.removeEventListener("resize",b,!1),c.removeEventListener("scroll",b,!1),e()}}(throttle(function(){a.update()},this._config.throttle)),this._started=!0),this._started},VisMon.Strategy.EventStrategy.prototype.stop=function(){return this._started?(this._removeEventListeners(),this._started=!1,!0):!1},VisSense.VisMon=VisMon,VisSense.PubSub=PubSub,VisSense.fn.monitor=function(a){return new VisMon(this,a)},VisSense.Utils={async:async,debounce:debounce,defaults:defaults,defer:defer,extend:extend,forEach:forEach,fireIf:fireIf,identity:identity,isArray:isArray,isDefined:isDefined,isElement:isElement,isFunction:isFunction,isObject:isObject,isPageVisible:isPageVisible,isVisibleByStyling:isVisibleByStyling,noop:noop,now:now,once:once,throttle:throttle,percentage:percentage,VisibilityApi:createVisibilityApi(),createVisibilityApi:createVisibilityApi,_viewport:viewport,_isInViewport:isInViewport,_isDisplayed:isDisplayed,_computedStyle:computedStyle,_styleProperty:styleProperty};